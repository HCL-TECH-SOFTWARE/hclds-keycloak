# Deploying custom theme

Themes are deployed into Keycloak by copying the theme directory to `themes` or it can be deployed as a `archive`. During development, copy the theme to the `themes` directory, but in production consider using a `archive`. For more information on how to create a custom theme, see [Custom themes](./custom-themes.md).

Please ensure you clone [hclds-keycloak](https://git.cwp.pnp-hcl.com/hclds/hclds-keycloak) repo to your local machine before you begin.

## Using Docker Compose

You can deploy your theme locally using `Docker Compose` for development purpose.


Create a docker compose file `docker-compose.yaml` in the root directory of the cloned repo and paste the following content:

```yaml
version: '3'
services:
  postgresql:
    image: bitnami/postgresql:15.3.0
    environment:
      - POSTGRESQL_PASSWORD=password
      - POSTGRESQL_USERNAME=dbuser
      - POSTGRESQL_DATABASE=keycloakdb
    network_mode: bridge

  keycloak:
    image: bitnami/keycloak:22
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
      - KEYCLOAK_DATABASE_NAME=keycloakdb
      - KEYCLOAK_DATABASE_HOST=postgresql
      - KEYCLOAK_DATABASE_USER=dbuser
      - KEYCLOAK_DATABASE_PASSWORD=password
    volumes:
        - src/themes/:/opt/bitnami/keycloak/themes/
    depends_on:
      - postgresql
    links:
      - postgresql
    ports:
      - "8080:8080"
    network_mode: bridge
```

Run the following command to deploy Keycloak with your custom theme:

```sh
docker compose -f docker-compose.yaml up -d
```

## Using Helm

### Building image

#### Building container image for custom theme
In this section you will see how to build a container image that includes pre-built custom theme.


Package the pre-built custom theme into a container image, by creating a file in the root directory and name it `Dockerfile.themes` and paste the following contents:

```Dockerfile
## Currently you are using busybox but you can use alpine image as well.
FROM busybox

# Copy contents of themes folder in the container
COPY src/themes/hcl /usr/src/themes/hcl
```

Once the `Dockerfile` is created run the following command to create a container image.

```sh
docker build -f Dockerfile.themes --no-cache -t hclds-keycloak-theme:latest .
```

#### Building container image for Keycloak
The Helm chart expects the image `hclds-keycloak:latest` on the system in order to properly start the service. Ensure this image on your system before running the following installation steps:
```sh
docker image ls | grep hclds-keycloak
Output: hclds-keycloak  latest    d2a806a74638    2 minutes ago   642MB
```
If the image is not available yet, please refer to the section [building the image for the service](../deployment/docker.md#build-the-container-for-the-service).

### Prepare a YAML file to provide the appropriate configuration

Create a custom values.yaml file `custom-values.yaml`:

```sh
vi custom-values.yaml
```

Add the following content to the `custom-values.yaml` file and replace the placeholders with appropriate values:
```yaml
image:
  registry: ""
  repository: hclds-keycloak
  tag: latest
# enable production mode
production: true

# production mode requires TLS to be set to true
tls:
  enabled: true
  autoGenerated: true

ingress:
  enabled: true
  ingressClassName: "nginx"
  hostname: <HOSTNAME>
  tls: true
  selfSigned: true

initContainers:
  - name: hclds-keycloak-theme
    image: hclds-keycloak-theme
    imagePullPolicy: IfNotPresent
    command: ["/bin/sh", "-c", "cp -R /usr/src/themes/hcl/. /opt/bitnami/keycloak/themes/hcl/; sleep 30;"]
    volumeMounts:
      - name: hcl-theme-volume
        mountPath: /opt/bitnami/keycloak/themes/hcl

extraVolumeMounts:
  - name: hcl-theme-volume
    mountPath: /opt/bitnami/keycloak/themes/hcl

extraVolumes:
  - name: hcl-theme-volume
    emptyDir: {}

extraEnvVars:
  - name: KEYCLOAK_DEFAULT_THEME
    value: hcl

```

> **_Note:_**
>
> Replace `<HOSTNAME>` with your respective hostname, for example `localhost`.

Once the `custom-values.yaml` file is created you can install helm charts in this repo from `deployment/helm/hclds-keycloak`.


### Running helm install

To install the chart on local with the release name hclds-keycloak, go to `deployment/helm/hclds-keycloak` and run:

```sh
helm install hclds-keycloak . -n hclds --create-namespace --values custom-values.yaml
```

### Verifying your Keycloak instance is running and healthy

Make sure that keycloak is up and running using following command:

```sh
kubectl get all -n hclds -o wide

Output:




NAME                              READY   STATUS    RESTARTS   AGE    IP             NODE       NOMINATED NODE   READINESS GATES
pod/hclds-keycloak-0              1/1     Running   0          114m   10.244.2.128   minikube   <none>           <none>
pod/hclds-keycloak-postgresql-0   1/1     Running   0          120m   10.244.2.126   minikube   <none>           <none>

NAME                                   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE    SELECTOR
service/hclds-keycloak                 ClusterIP   10.102.107.155   <none>        80/TCP,443/TCP   120m   app.kubernetes.io/component=hclds-keycloak,app.kubernetes.io/instance=hclds-keycloak,app.kubernetes.io/name=hclds-keycloak
service/hclds-keycloak-headless        ClusterIP   None             <none>        80/TCP,443/TCP   120m   app.kubernetes.io/component=hclds-keycloak,app.kubernetes.io/instance=hclds-keycloak,app.kubernetes.io/name=hclds-keycloak
service/hclds-keycloak-postgresql      ClusterIP   10.106.187.209   <none>        5432/TCP         120m   app.kubernetes.io/component=primary,app.kubernetes.io/instance=hclds-keycloak,app.kubernetes.io/name=postgresql
service/hclds-keycloak-postgresql-hl   ClusterIP   None             <none>        5432/TCP         120m   app.kubernetes.io/component=primary,app.kubernetes.io/instance=hclds-keycloak,app.kubernetes.io/name=postgresql

NAME                                         READY   AGE    CONTAINERS       IMAGES
statefulset.apps/hclds-keycloak              1/1     120m   hclds-keycloak   hclds-keycloak:latest
statefulset.apps/hclds-keycloak-postgresql   1/1     120m   postgresql       docker.io/bitnami/postgresql:15.3.0-debian-11-r74
```

## Verify your Keycloak deployment

Once all steps have been executed, the Keycloak instance is available at:

- For Helm deployment, Keycloak instance is available through the URL `https://<HOSTNAME>/`. 
- For Docker compose, Keycloak instance is accessible at `http://localhost:8080`.
Once Keycloak is deployed successfully, verify if the custom theme shows up in the theme selector. To verify follow the steps:

1. Log into the **Admin** Console.
1. Select your realm from the drop-down box in the top left corner.
1. Click **Realm Settings** from the menu.
1. Click the **Themes** tab.
    1. To set the theme for the master Admin Console you should select `hcl` theme for the master realm.
    1. To see the changes to the Admin Console refresh the page.
